<!DOCTYPE html>
<html lang="ar" dir="rtl">

    <%- include("./partials/head.ejs") %>

<body>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background-color: #121212;
            color: #ffffff;
        }

        .upload-container {
            background-color: rgba(30, 30, 30, 0.8);
            border: 2px solid #25D366;
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            margin: 20px auto;
        }

        h1 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.8rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .file-input-wrapper {
            position: relative;
            width: 100%;
        }

        .file-label {
            display: block;
            background-color: rgba(37, 211, 102, 0.1);
            border: 2px dashed #25D366;
            border-radius: 10px;
            padding: 20px;
            color: #25D366;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .file-label:hover {
            background-color: rgba(37, 211, 102, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.2);
        }

        #file, #fileMSG {
            display: none;
        }

        .upload-btn {
            margin-top: 20px;
            padding: 15px 30px;
            border: none;
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: #ffffff;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3);
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #128C7E, #075E54);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(37, 211, 102, 0.4);
        }

        .output {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background-color: rgba(30, 30, 30, 0.8);
            border-left: 4px solid #25D366;
        }

        .hidden {
            display: none;
        }

        .form-control {
            background-color: #2d2d2d;
            border: 1px solid #25D366;
            color: #ffffff;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            background-color: #2d2d2d;
            border-color: #25D366;
            color: #ffffff;
            box-shadow: 0 0 0 0.25rem rgba(37, 211, 102, 0.25);
            transform: translateY(-2px);
        }

        .form-control::placeholder {
            color: #aaaaaa;
        }

        .card {
            background-color: #1e1e1e;
            border: 1px solid rgba(37, 211, 102, 0.2);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(37, 211, 102, 0.4);
        }

        .card-header {
            background: linear-gradient(135deg, #128C7E, #25D366);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-body {
            padding: 20px;
        }

        select.form-control {
            height: 50px;
            background-color: #2d2d2d;
            color: white;
            border-color: #25D366;
            border-radius: 10px;
            cursor: pointer;
        }

        select.form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(37, 211, 102, 0.25);
        }

        .section-title {
            color: #25D366;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 2px solid #25D366;
            padding-bottom: 10px;
            display: inline-block;
        }

        .alert {
            background-color: rgba(37, 211, 102, 0.1);
            border-left: 4px solid #25D366;
            color: #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .alert i {
            color: #25D366;
            margin-right: 10px;
        }

        .progress {
            height: 8px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            margin-top: 10px;
        }

        .progress-bar {
            background-color: #25D366;
        }

        .message-counter {
            background-color: rgba(37, 211, 102, 0.1);
            border: 1px solid #25D366;
            border-radius: 10px;
            padding: 10px 15px;
            margin-top: 15px;
            display: inline-block;
            font-weight: 600;
            color: #25D366;
        }

        .message-counter i {
            margin-right: 8px;
        }

        .whatsapp-icon {
            background: linear-gradient(135deg, #25D366, #128C7E);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .whatsapp-icon i {
            color: white;
            font-size: 20px;
        }

        .feature-card {
            background-color: #262626;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            border-left: 4px solid #25D366;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .feature-icon {
            font-size: 24px;
            color: #25D366;
            margin-bottom: 15px;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: white;
        }

        .feature-description {
            color: #aaaaaa;
            font-size: 14px;
        }
    </style>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-2">
                <%- include("./partials/nav.ejs") %>
            </div>

            <div class="col-lg-10">
                <main>
                    <div class="row">
                        <div class="col-md-6">
                            <h2 class="mb-4">
                                <i class="fab fa-whatsapp me-2" style="color: #25D366;"></i>
                                إدارة رسائل واتساب
                            </h2>
                        </div>

                        <div class="col-md-6">
                            <div class="left" style="margin-top: 0.2rem;">
                                <%- include("./partials/top.ejs") %>
                            </div>
                        </div>
                    </div>

                    <!-- Features Overview -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="feature-title">إرسال حالة الواجب</div>
                                <div class="feature-description">
                                    إرسال تنبيهات لأولياء الأمور عن حالة واجبات الطلاب
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="feature-title">إرسال درجات الامتحانات</div>
                                <div class="feature-description">
                                    إرسال نتائج الامتحانات والاختبارات لأولياء الأمور بشكل فوري
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="feature-title">إدارة المجموعات</div>
                                <div class="feature-description">
                                    إنشاء وإدارة مجموعات واتساب للفصول الدراسية المختلفة
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header d-flex align-items-center">
                            <div class="whatsapp-icon">
                                <i class="fab fa-whatsapp"></i>
                            </div>
                            <span>نوع الإرسال</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-4">
                                    <select name="chapterGrade" id="optionSelect" class="form-control text-center" required>
                                        <option value="">اختر نوع الإرسال</option>
                                        <option value="msgWithoutPhoto">إرسال حالة الواجب</option>
                                        <option value="gradeMsg">إرسال درجات الامتحان</option>
                                        <option value="sendMsg">ارسال رساله عامة</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section for "إرسال حالة الواجب" -->
                    <div id="msgWithoutPhotoSection" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-tasks me-2"></i> إرسال حالة الواجب
                            </div>
                            <div class="card-body">
                                <div class="alert">
                                    <i class="fas fa-info-circle"></i>
                                    قم برفع ملف إكسل يحتوي على بيانات الطلاب وحالة الواجب
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <label for="phoneCloumnNameMSG">عمود أرقام أولياء الأمور</label>
                                        <input type="text" id="phoneCloumnNameMSG" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="nameCloumnNameMSG">عمود أسماء الطلاب</label>
                                        <input type="text" id="nameCloumnNameMSG" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="HWCloumnName">عمود حالة الواجب</label>
                                        <input type="text" id="HWCloumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                </div>

                                <div class="upload-container">
                                    <h1>رفع ملف الإكسل</h1>
                                    <div class="file-input-wrapper">
                                        <label for="fileMSG" class="file-label" id="fileLabelMSG">
                                            <i class="fas fa-file-excel me-2"></i> اختر ملف الإكسل
                                        </label>
                                        <input type="file" id="fileMSG" name="fileMSG" accept=".xlsx, .xls" required onchange="updateFileNameMSG()">
                                    </div>
                                    <button class="upload-btn" onclick="handleFileMSG()">
                                        <i class="fas fa-paper-plane me-2"></i> إرسال الرسائل
                                    </button>

                                    <div id="progressContainerMSG" class="mt-3 d-none">
                                        <div class="progress">
                                            <div id="progressBarMSG" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-center mt-2" id="progressTextMSG">جاري الإرسال...</p>
                                    </div>

                                    <div class="output" id="outputMSG"></div>
                                    <div class="message-counter d-none" id="numberOfSendMSG">
                                        <i class="fas fa-check-circle"></i> تم إرسال <span id="msgCountMSG">0</span> رسالة
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section for "إرسال رسائل بصورة" -->
                    <div id="msgWithPhotoSection" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-image me-2"></i> إرسال رسائل بصورة
                            </div>
                            <div class="card-body">
                                <div class="alert">
                                    <i class="fas fa-info-circle"></i>
                                    قم برفع ملف إكسل يحتوي على بيانات الطلاب والصورة المراد إرسالها
                                </div>
                                
                                <div class="col-md-4 mb-4">
                                    <input type="file" class="form-control" placeholder="اختر الصورة">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section for "إرسال درجات" -->
                    <div id="gradeMsgSection" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar me-2"></i> إرسال درجات الامتحان
                            </div>
                            <div class="card-body">
                                <div class="alert">
                                    <i class="fas fa-info-circle"></i>
                                    قم برفع ملف إكسل يحتوي على بيانات الطلاب ودرجاتهم
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <label for="quizName">اسم الامتحان</label>
                                        <input type="text" id="quizName" class="form-control" placeholder="مثال: امتحان منتصف الفصل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="phoneCloumnName">عمود أرقام أولياء الأمور</label>
                                        <input type="text" id="phoneCloumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="gradeCloumnName">عمود الدرجات</label>
                                        <input type="text" id="gradeCloumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="nameCloumnName">عمود أسماء الطلاب</label>
                                        <input type="text" id="nameCloumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="maxGrade">الدرجة النهائية</label>
                                        <input type="text" id="maxGrade" class="form-control" placeholder="مثال: 100">
                                    </div>
                                </div>

                                <div class="upload-container">
                                    <h1>رفع ملف الإكسل</h1>
                                    <div class="file-input-wrapper">
                                        <label for="file" class="file-label" id="fileLabel">
                                            <i class="fas fa-file-excel me-2"></i> اختر ملف الإكسل
                                        </label>
                                        <input type="file" id="file" name="file" accept=".xlsx, .xls" required onchange="updateFileName()">
                                    </div>
                                    <button class="upload-btn" onclick="handleFile()">
                                        <i class="fas fa-paper-plane me-2"></i> إرسال الرسائل
                                    </button>

                                    <div id="progressContainer" class="mt-3 d-none">
                                        <div class="progress">
                                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-center mt-2" id="progressText">جاري الإرسال...</p>
                                    </div>

                                    <div class="output" id="output"></div>
                                    <div class="message-counter d-none" id="numberOfSend">
                                        <i class="fas fa-check-circle"></i> تم إرسال <span id="msgCount">0</span> رسالة
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section for "ارسال رساله عامة" -->
                    <div id="sendMsgSection" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-envelope me-2"></i> ارسال رساله عامة
                            </div>
                            <div class="card-body">
                                <div class="alert">
                                    <i class="fas fa-info-circle"></i>
                                    قم برفع ملف إكسل يحتوي على بيانات المستلمين
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <label for="recipientType">المُرسل إليه</label>
                                        <select id="recipientType" class="form-control">
                                            <option value="">اختر المُرسل إليه</option>
                                            <option value="parents">اولياء الامور فقط</option>
                                            <option value="students">الطلاب فقط</option>
                                            <option value="both">كلاهما</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <label for="parentPhoneColumnName">عمود ارقام اولياء الامور</label>
                                        <input type="text" id="parentPhoneColumnName" class="form-control" placeholder="اسم عمود ارقام اولياء الامور">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="studentPhoneColumnName">عمود ارقام الطلاب</label>
                                        <input type="text" id="studentPhoneColumnName" class="form-control" placeholder="اسم عمود ارقام الطلاب">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="nameCloumnNameGEN">عمود اسماء الطلاب</label>
                                        <input type="text" id="nameCloumnNameGEN" class="form-control" placeholder="اسم عمود اسماء الطلاب (اختياري)">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-8 mb-4">
                                        <label for="customMessage">نص الرسالة</label>
                                        <textarea id="customMessage" class="form-control" rows="4" placeholder="اكتب الرسالة التي تريد ارسالها"></textarea>
                                    </div>
                                </div>

                                <div class="upload-container">
                                    <h1>رفع ملف الإكسل</h1>
                                    <div class="file-input-wrapper">
                                        <label for="fileGEN" class="file-label" id="fileLabelGEN">
                                            <i class="fas fa-file-excel me-2"></i> اختر ملف الإكسل
                                        </label>
                                        <input type="file" id="fileGEN" name="fileGEN" accept=".xlsx, .xls" required onchange="updateFileNameGEN()">
                                    </div>
                                    <button class="upload-btn" onclick="handleFileGEN()">
                                        <i class="fas fa-paper-plane me-2"></i> إرسال الرسائل
                                    </button>

                                    <div id="progressContainerGEN" class="mt-3 d-none">
                                        <div class="progress">
                                            <div id="progressBarGEN" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-center mt-2" id="progressTextGEN">جاري الإرسال...</p>
                                    </div>

                                    <div class="output" id="outputGEN"></div>
                                    <div class="message-counter d-none" id="numberOfSendGEN">
                                        <i class="fas fa-check-circle"></i> تم إرسال <span id="msgCountGEN">0</span> رسالة
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script src="../assest/bootstrap.bundle.min.js"></script>
    <script src="../assest/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        const optionSelect = document.getElementById('optionSelect');
        const msgWithoutPhotoSection = document.getElementById('msgWithoutPhotoSection');
        const msgWithPhotoSection = document.getElementById('msgWithPhotoSection');
        const gradeMsgSection = document.getElementById('gradeMsgSection');
        const sendMsgSection = document.getElementById('sendMsgSection');

        // Event listener to show/hide sections based on selection
        optionSelect.addEventListener('change', function () {
            const selectedValue = optionSelect.value;

            // Hide all sections initially
            msgWithoutPhotoSection.classList.add('hidden');
            msgWithPhotoSection.classList.add('hidden');
            gradeMsgSection.classList.add('hidden');
            sendMsgSection.classList.add('hidden');

            // Show corresponding section
            if (selectedValue === 'msgWithoutPhoto') {
                msgWithoutPhotoSection.classList.remove('hidden');
            } else if (selectedValue === 'msgWithPhoto') {
                msgWithPhotoSection.classList.remove('hidden');
            } else if (selectedValue === 'gradeMsg') {
                gradeMsgSection.classList.remove('hidden');
            } else if (selectedValue === 'sendMsg') {
                sendMsgSection.classList.remove('hidden');
            }
        });

        // Function to handle file reading
        function updateFileName() {
            const input = document.getElementById('file');
            const fileLabel = document.getElementById('fileLabel');
            if (input.files.length > 0) {
                fileLabel.innerHTML = `<i class="fas fa-file-alt"></i> ${input.files[0].name}`;
            }
        }

        // Function to handle file reading and show "Uploaded" status
        function handleFile() {
            const input = document.getElementById('file');
            const fileLabel = document.getElementById('fileLabel');

            if (!input.files.length) {
                alert('Please select a file!');
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                console.log(sheetName);
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);
                console.log(json);

                displayDataAndSend(json);

                // Update label to indicate that the file is uploaded
                fileLabel.innerHTML = `<i class="fas fa-check-circle"></i> ${file.name} (Uploaded)`;
                fileLabel.style.color = "green";
            };

            reader.readAsArrayBuffer(file);
        }

        // Function to send the data
        async function displayDataAndSend(data) {
            const output = document.getElementById('output');

            output.innerHTML = 'data is being sent...';
            const phoneCloumnName = document.getElementById('phoneCloumnName');
            const gradeCloumnName = document.getElementById('gradeCloumnName');
            const nameCloumnName = document.getElementById('nameCloumnName');
            const quizName = document.getElementById('quizName');
            const maxGrade = document.getElementById('maxGrade');

            if (!phoneCloumnName.value || !gradeCloumnName.value || !nameCloumnName.value || !quizName.value || !maxGrade.value ) {
                alert('ادخل اسامي ال cloumn');
                return;
            }

            const dataSend = {
                phoneCloumnName: phoneCloumnName.value,
                gradeCloumnName: gradeCloumnName.value,
                nameCloumnName: nameCloumnName.value,
                quizName: quizName.value,
                maxGrade: maxGrade.value,
                dataToSend: data
            };

            try {
                const response = await fetch('/teacher/sendGradeMessages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataSend)
                });

                const responseData = await response.json();

                if (response.ok) {
                    output.innerHTML = `<h2>تم الارسال بنجاح</h2>`;
                    output.style.color = "green";
                } else {
                    output.innerHTML = `<h2>حدث خطأ أثناء الارسال</h2>`;
                    output.style.color = "red";
                }
            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = `<h2>حدث خطأ أثناء الارسال</h2>`;
                output.style.color = "red";
            }
        }
    
    </script>



    <script>

                // Function to handle file reading
        function updateFileNameMSG() {
            const input = document.getElementById('fileMSG');
            const fileLabel = document.getElementById('fileLabelMSG');
            if (input.files.length > 0) {
                fileLabel.innerHTML = `<i class="fas fa-file-alt"></i> ${input.files[0].name}`;
            }
        }

        // Function to handle file reading and show "Uploaded" status
        function handleFileMSG() {
            const input = document.getElementById('fileMSG');
            const fileLabel = document.getElementById('fileLabelMSG');

            if (!input.files.length) {
                alert('Please select a file!');
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                console.log(sheetName);
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);
                console.log(json);

                displayDataAndSendMSG(json);

                // Update label to indicate that the file is uploaded
                fileLabel.innerHTML = `<i class="fas fa-check-circle"></i> ${file.name} (Uploaded)`;
                fileLabel.style.color = "green";
            };

            reader.readAsArrayBuffer(file);
        }

        // Function to send the data
        async function displayDataAndSendMSG(data) {
            const output = document.getElementById('outputMSG');

            output.innerHTML = 'data is being sent...';
            const phoneCloumnName = document.getElementById('phoneCloumnNameMSG');
            const nameCloumnNameMSG = document.getElementById('nameCloumnNameMSG');
            const HWCloumnName = document.getElementById('HWCloumnName');

            if (!phoneCloumnName.value  || !nameCloumnNameMSG.value || !HWCloumnName.value ) {
                alert('ادخل اسامي ال cloumn');
                return;
            }

            const dataSend = {
                phoneCloumnName: phoneCloumnName.value,
                nameCloumnName: nameCloumnNameMSG.value,
                HWCloumnName : HWCloumnName.value ,
                dataToSend: data
            };

            try {
                const response = await fetch('/teacher/sendMessages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataSend)
                });

                const responseData = await response.json();

                if (response.ok) {
                    output.innerHTML = `<h2>تم الارسال بنجاح</h2>`;
                    output.style.color = "green";
                } else {
                    output.innerHTML = `<h2>حدث خطأ أثناء الارسال</h2>`;
                    output.style.color = "red";
                }
            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = `<h2>حدث خطأ أثناء الارسال</h2>`;
                output.style.color = "red";
            }
        }
    

        
    </script>

    <script>
        // General message upload and send
        function updateFileNameGEN() {
            const input = document.getElementById('fileGEN');
            const fileLabel = document.getElementById('fileLabelGEN');
            if (input.files.length > 0) {
                fileLabel.innerHTML = `<i class="fas fa-file-alt"></i> ${input.files[0].name}`;
            }
        }

        function handleFileGEN() {
            const input = document.getElementById('fileGEN');
            const fileLabel = document.getElementById('fileLabelGEN');

            if (!input.files.length) {
                alert('Please select a file!');
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);

                displayDataAndSendGEN(json);

                fileLabel.innerHTML = `<i class=\"fas fa-check-circle\"></i> ${file.name} (Uploaded)`;
                fileLabel.style.color = "green";
            };

            reader.readAsArrayBuffer(file);
        }

        async function displayDataAndSendGEN(data) {
            const output = document.getElementById('outputGEN');
            output.innerHTML = 'data is being sent...';

            const recipientType = document.getElementById('recipientType').value;
            const parentPhoneColumnName = document.getElementById('parentPhoneColumnName').value;
            const studentPhoneColumnName = document.getElementById('studentPhoneColumnName').value;
            const nameCloumnNameGEN = document.getElementById('nameCloumnNameGEN').value;
            const customMessage = document.getElementById('customMessage').value;

            if (!recipientType || !customMessage) {
                alert('الرجاء اختيار المُرسل إليه وكتابة الرسالة');
                return;
            }

            if ((recipientType === 'parents' || recipientType === 'both') && !parentPhoneColumnName) {
                alert('ادخل اسم عمود ارقام اولياء الامور');
                return;
            }
            if ((recipientType === 'students' || recipientType === 'both') && !studentPhoneColumnName) {
                alert('ادخل اسم عمود ارقام الطلاب');
                return;
            }

            const payload = {
                recipientType,
                parentPhoneColumnName,
                studentPhoneColumnName,
                nameCloumnName: nameCloumnNameGEN,
                message: customMessage,
                dataToSend: data
            };

            try {
                const response = await fetch('/teacher/sendCustomMessages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json();
                if (response.ok) {
                    output.innerHTML = `<h2>تم الارسال بنجاح</h2>`;
                    output.style.color = 'green';
                } else {
                    output.innerHTML = `<h2>حدث خطأ أثناء الارسال</h2>`;
                    output.style.color = 'red';
                }
            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = `<h2>حدث خطأ أثناء الارسال</h2>`;
                output.style.color = 'red';
            }
        }
    </script>



    <script src="/socket.io/socket.io.js"></script>
    <script>
        const numberOfSend = document.getElementById('numberOfSend');
        const numberOfSendMSG = document.getElementById('numberOfSendMSG');
        const numberOfSendGEN = document.getElementById('numberOfSendGEN');
        const socket = io();

        socket.on('sendingMessages', (data) => {
            numberOfSend.classList.remove('d-none');
            numberOfSend.innerHTML = `تم ارسال ${data.nMessages} رساله`;

            numberOfSendMSG.classList.remove('d-none');
            numberOfSendMSG.innerHTML = `تم ارسال ${data.nMessages} رساله`;
            numberOfSendGEN.classList.remove('d-none');
            numberOfSendGEN.innerHTML = `تم ارسال ${data.nMessages} رساله`;
                
        });
    </script>

</body>

</html>
