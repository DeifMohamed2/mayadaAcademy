<!DOCTYPE html>
<html lang="ar" dir="rtl">

    <%- include("./partials/head.ejs") %>

<body>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background-color: #121212;
            color: #ffffff;
        }

        .upload-container {
            background-color: rgba(30, 30, 30, 0.8);
            border: 2px solid #25D366;
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            margin: 20px auto;
        }

        h1 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.8rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .file-input-wrapper {
            position: relative;
            width: 100%;
        }

        .file-label {
            display: block;
            background-color: rgba(37, 211, 102, 0.1);
            border: 2px dashed #25D366;
            border-radius: 10px;
            padding: 20px;
            color: #25D366;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .file-label:hover {
            background-color: rgba(37, 211, 102, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.2);
        }

        #file, #fileMSG {
            display: none;
        }

        .upload-btn {
            margin-top: 20px;
            padding: 15px 30px;
            border: none;
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: #ffffff;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3);
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #128C7E, #075E54);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(37, 211, 102, 0.4);
        }

        .output {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background-color: rgba(30, 30, 30, 0.8);
            border-left: 4px solid #25D366;
        }

        .hidden {
            display: none;
        }

        .form-control {
            background-color: #2d2d2d;
            border: 1px solid #25D366;
            color: #ffffff;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            background-color: #2d2d2d;
            border-color: #25D366;
            color: #ffffff;
            box-shadow: 0 0 0 0.25rem rgba(37, 211, 102, 0.25);
            transform: translateY(-2px);
        }

        .form-control::placeholder {
            color: #aaaaaa;
        }

        .card {
            background-color: #1e1e1e;
            border: 1px solid rgba(37, 211, 102, 0.2);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(37, 211, 102, 0.4);
        }

        .card-header {
            background: linear-gradient(135deg, #128C7E, #25D366);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-body {
            padding: 20px;
        }

        select.form-control {
            height: 50px;
            background-color: #2d2d2d;
            color: white;
            border-color: #25D366;
            border-radius: 10px;
            cursor: pointer;
        }

        select.form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(37, 211, 102, 0.25);
        }

        .section-title {
            color: #25D366;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 2px solid #25D366;
            padding-bottom: 10px;
            display: inline-block;
        }

        .alert {
            background-color: rgba(37, 211, 102, 0.1);
            border-left: 4px solid #25D366;
            color: #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .alert i {
            color: #25D366;
            margin-right: 10px;
        }

        .progress {
            height: 8px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            margin-top: 10px;
        }

        .progress-bar {
            background-color: #25D366;
        }

        .message-counter {
            background-color: rgba(37, 211, 102, 0.1);
            border: 1px solid #25D366;
            border-radius: 10px;
            padding: 10px 15px;
            margin-top: 15px;
            display: inline-block;
            font-weight: 600;
            color: #25D366;
        }

        .message-counter i {
            margin-right: 8px;
        }

        .progress-details {
            margin-top: 20px;
            padding: 20px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(37, 211, 102, 0.2);
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            color: white;
        }

        .stat-card.success {
            background-color: rgba(37, 211, 102, 0.2);
            border: 1px solid #25D366;
        }

        .stat-card.error {
            background-color: rgba(255, 59, 48, 0.2);
            border: 1px solid #FF3B30;
        }

        .stat-card.info {
            background-color: rgba(0, 122, 255, 0.2);
            border: 1px solid #007AFF;
        }

        .stat-card.warning {
            background-color: rgba(255, 149, 0, 0.2);
            border: 1px solid #FF9500;
        }

        .stat-card i {
            font-size: 20px;
            margin-bottom: 10px;
            display: block;
        }

        .stat-card span {
            font-size: 18px;
            font-weight: bold;
        }

        .error-log {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(255, 59, 48, 0.1);
            border: 1px solid #FF3B30;
            border-radius: 10px;
        }

        .error-log h6 {
            color: #FF3B30;
            margin-bottom: 15px;
        }

        .error-item {
            background-color: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .error-item:hover {
            background-color: rgba(255, 59, 48, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 59, 48, 0.2);
        }

        .error-item .error-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .error-item .student-name {
            font-weight: bold;
            color: #FF3B30;
            font-size: 16px;
        }

        .error-item .phone-number {
            color: #FF9500;
            font-weight: 600;
            font-size: 14px;
            background-color: rgba(255, 149, 0, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 149, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .error-item .phone-number:hover {
            background-color: rgba(255, 149, 0, 0.2);
            transform: scale(1.05);
        }

        .error-item .phone-number::after {
            content: "انقر للنسخ";
            position: absolute;
            top: -25px;
            right: 0;
            background-color: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
        }

        .error-item .phone-number:hover::after {
            opacity: 1;
        }

        .error-item .error-message {
            color: #e0e0e0;
            font-size: 14px;
            margin: 10px 0;
            padding: 10px;
            background-color: rgba(255, 59, 48, 0.1);
            border-radius: 6px;
            border-left: 3px solid #FF3B30;
        }

        .error-item .error-timestamp {
            color: #888;
            font-size: 12px;
            text-align: right;
            margin-top: 8px;
        }

        .error-item i {
            margin-left: 6px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 10px;
            font-weight: 500;
        }

        .alert-success {
            background-color: rgba(37, 211, 102, 0.1);
            border-color: #25D366;
            color: #25D366;
        }

        .alert-danger {
            background-color: rgba(255, 59, 48, 0.1);
            border-color: #FF3B30;
            color: #FF3B30;
        }

        .alert-warning {
            background-color: rgba(255, 149, 0, 0.1);
            border-color: #FF9500;
            color: #FF9500;
        }

        .alert-info {
            background-color: rgba(0, 122, 255, 0.1);
            border-color: #007AFF;
            color: #007AFF;
        }

        .alert i {
            margin-left: 8px;
        }

        .whatsapp-icon {
            background: linear-gradient(135deg, #25D366, #128C7E);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .whatsapp-icon i {
            color: white;
            font-size: 20px;
        }

        .feature-card {
            background-color: #262626;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            border-left: 4px solid #25D366;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .feature-icon {
            font-size: 24px;
            color: #25D366;
            margin-bottom: 15px;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: white;
        }

        .feature-description {
            color: #aaaaaa;
            font-size: 14px;
        }
    </style>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-2">
                <%- include("./partials/nav.ejs") %>
            </div>

            <div class="col-lg-10">
                <main>
                    <div class="row">
                        <div class="col-md-6">
                            <h2 class="mb-4">
                                <i class="fab fa-whatsapp me-2" style="color: #25D366;"></i>
                                إدارة رسائل واتساب
                            </h2>
                        </div>

                        <div class="col-md-6">
                            <div class="left" style="margin-top: 0.2rem;">
                                <%- include("./partials/top.ejs") %>
                            </div>
                        </div>
                    </div>

                    <!-- Features Overview -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="feature-title">إرسال حالة الواجب</div>
                                <div class="feature-description">
                                    إرسال تنبيهات لأولياء الأمور عن حالة واجبات الطلاب
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="feature-title">إرسال درجات الامتحانات</div>
                                <div class="feature-description">
                                    إرسال نتائج الامتحانات والاختبارات لأولياء الأمور بشكل فوري
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="fas fa-user-check"></i>
                                </div>
                                <div class="feature-title">إرسال الحضور</div>
                                <div class="feature-description">
                                    إرسال تقارير الحضور والغياب مع تفاصيل وقت الحضور
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div class="feature-title">رسائل عامة</div>
                                <div class="feature-description">
                                    إرسال رسائل مخصصة لأولياء الأمور أو الطلاب
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header d-flex align-items-center">
                            <div class="whatsapp-icon">
                                <i class="fab fa-whatsapp"></i>
                            </div>
                            <span>نوع الإرسال</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-4">
                                    <select name="chapterGrade" id="optionSelect" class="form-control text-center" required>
                                        <option value="">اختر نوع الإرسال</option>
                                        <option value="msgWithoutPhoto">إرسال حالة الواجب</option>
                                        <option value="gradeMsg">إرسال درجات الامتحان</option>
                                        <option value="sendMsg">ارسال رساله عامة</option>
                                        <option value="attendanceMsg">ارسل الحضور</option>
                                        <option value="collectionMsg">رسالة مجمعة (حضور/واجب/امتحان متعدد التواريخ)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section for "إرسال حالة الواجب" -->
                    <div id="msgWithoutPhotoSection" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-tasks me-2"></i> إرسال حالة الواجب
                            </div>
                            <div class="card-body">
                                <div class="alert">
                                    <i class="fas fa-info-circle"></i>
                                    قم برفع ملف إكسل يحتوي على بيانات الطلاب وحالة الواجب
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-4">
                                        <label for="phoneCloumnNameMSG">عمود أرقام أولياء الأمور</label>
                                        <input type="text" id="phoneCloumnNameMSG" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="nameCloumnNameMSG">عمود أسماء الطلاب</label>
                                        <input type="text" id="nameCloumnNameMSG" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="HWCloumnName">عمود حالة الواجب</label>
                                        <input type="text" id="HWCloumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="courseNameMSG">اسم الكورس</label>
                                        <input type="text" id="courseNameMSG" class="form-control" value="Basics Course" placeholder="مثال: Basics Course">
                                    </div>
                                </div>

                                <div class="upload-container">
                                    <h1>رفع ملف الإكسل</h1>
                                    <div class="file-input-wrapper">
                                        <label for="fileMSG" class="file-label" id="fileLabelMSG">
                                            <i class="fas fa-file-excel me-2"></i> اختر ملف الإكسل
                                        </label>
                                        <input type="file" id="fileMSG" name="fileMSG" accept=".xlsx, .xls" required onchange="updateFileNameMSG()">
                                    </div>
                                    <button class="upload-btn" onclick="handleFileMSG()">
                                        <i class="fas fa-paper-plane me-2"></i> إرسال الرسائل
                                    </button>

                                    <div id="progressContainerMSG" class="mt-3 d-none">
                                        <div class="progress">
                                            <div id="progressBarMSG" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-center mt-2" id="progressTextMSG">جاري الإرسال...</p>
                                    </div>

                                    <div class="output" id="outputMSG"></div>
                                    <div class="message-counter d-none" id="numberOfSendMSG">
                                        <i class="fas fa-check-circle"></i> تم إرسال <span id="msgCountMSG">0</span> رسالة
                                    </div>
                                    <div class="progress-details d-none" id="progressDetailsMSG">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="stat-card success">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span id="successCountMSG">0</span> نجح
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card error">
                                                    <i class="fas fa-times-circle"></i>
                                                    <span id="errorCountMSG">0</span> فشل
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card info">
                                                    <i class="fas fa-clock"></i>
                                                    <span id="currentStudentMSG">-</span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card warning">
                                                    <i class="fas fa-percentage"></i>
                                                    <span id="progressPercentMSG">0%</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="error-log d-none" id="errorLogMSG">
                                            <h6><i class="fas fa-exclamation-triangle"></i> تفاصيل الأخطاء:</h6>
                                            
                                            <!-- Export Button -->
                                            <div class="mb-3 text-center">
                                              <button id="exportErrorsBtnMSG" class="upload-btn" style="background-color: #FF9500; border-color: #FF9500; color: white; margin: 0;">
                                                <i class="fas fa-download me-2"></i> تصدير الأخطاء إلى Excel
                                              </button>
                                            </div>
                                            
                                            <div class="error-summary mb-3">
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-info-circle"></i>
                                                    إجمالي الرسائل الفاشلة: <span id="totalErrorsMSG">0</span>
                                                    <br><small>يمكنك رؤية التفاصيل أدناه مع أرقام الهواتف</small>
                                                </div>
                                            </div>
                                            <div id="errorDetailsMSG"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section for "إرسال رسائل بصورة" -->
                    <div id="msgWithPhotoSection" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-image me-2"></i> إرسال رسائل بصورة
                            </div>
                            <div class="card-body">
                                <div class="alert">
                                    <i class="fas fa-info-circle"></i>
                                    قم برفع ملف إكسل يحتوي على بيانات الطلاب والصورة المراد إرسالها
                                </div>
                                
                                <div class="col-md-4 mb-4">
                                    <input type="file" class="form-control" placeholder="اختر الصورة">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section for "إرسال درجات" -->
                    <div id="gradeMsgSection" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar me-2"></i> إرسال درجات الامتحان
                            </div>
                            <div class="card-body">
                                <div class="alert">
                                    <i class="fas fa-info-circle"></i>
                                    قم برفع ملف إكسل يحتوي على بيانات الطلاب ودرجاتهم
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <label for="quizName">اسم الامتحان</label>
                                        <input type="text" id="quizName" class="form-control" placeholder="مثال: امتحان منتصف الفصل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="courseName">اسم الكورس (اختياري)</label>
                                        <input type="text" id="courseName" class="form-control" placeholder="مثال: Basics Course">
                                        <!-- <small class="text-muted">سيتم إضافته لجميع الطلاب</small> -->
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="phoneCloumnName">عمود أرقام أولياء الأمور</label>
                                        <input type="text" id="phoneCloumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="gradeCloumnName">عمود الدرجات</label>
                                        <input type="text" id="gradeCloumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="nameCloumnName">عمود أسماء الطلاب</label>
                                        <input type="text" id="nameCloumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="maxGrade">الدرجة النهائية</label>
                                        <input type="text" id="maxGrade" class="form-control" placeholder="مثال: 100">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="examEntryCloumnName">عمود دخول الامتحان (اختياري)</label>
                                        <input type="text" id="examEntryCloumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                        <small class="text-muted">اتركه فارغاً إذا لم يكن موجوداً في الملف</small>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-4">
                                        <div class="card" id="onlineQuizCard" style="background-color: #262626; border: 2px solid #666; border-radius: 15px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; min-height: 120px;" onclick="toggleOnlineQuiz()">
                                            <div class="card-body" style="padding: 20px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                                                <div class="form-check" style="margin: 0; display: flex; align-items: center; gap: 10px;">
                                                    <input class="form-check-input" type="checkbox" id="onlineQuizCheckbox" style="background-color: #666; border-color: #666; width: 18px; height: 18px; cursor: pointer; margin: 0;" onclick="event.stopPropagation()">
                                                    <label class="form-check-label" for="onlineQuizCheckbox" style="color: #ffffff; font-weight: 600; font-size: 16px; cursor: pointer; margin: 0;">
                                                        <i class="fas fa-laptop me-2" style="color: #666;"></i> Online Quiz
                                                    </label>
                                                </div>
                                                <!-- <small class="text-muted mt-2" style="color: #aaaaaa; font-size: 12px; line-height: 1.4;">
                                                    رسالة بتنسيق إلكتروني
                                                </small> -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="upload-container">
                                    <h1>رفع ملف الإكسل</h1>
                                    <div class="file-input-wrapper">
                                        <label for="file" class="file-label" id="fileLabel">
                                            <i class="fas fa-file-excel me-2"></i> اختر ملف الإكسل
                                        </label>
                                        <input type="file" id="file" name="file" accept=".xlsx, .xls" required onchange="updateFileName()">
                                    </div>
                                    <button class="upload-btn" onclick="handleFile()">
                                        <i class="fas fa-paper-plane me-2"></i> إرسال الرسائل
                                    </button>

                                    <div id="progressContainer" class="mt-3 d-none">
                                        <div class="progress">
                                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-center mt-2" id="progressText">جاري الإرسال...</p>
                                    </div>

                                    <div class="output" id="output"></div>
                                    <div class="message-counter d-none" id="numberOfSend">
                                        <i class="fas fa-check-circle"></i> تم إرسال <span id="msgCount">0</span> رسالة
                                    </div>
                                    <div class="progress-details d-none" id="progressDetails">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="stat-card success">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span id="successCount">0</span> نجح
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card error">
                                                    <i class="fas fa-times-circle"></i>
                                                    <span id="errorCount">0</span> فشل
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card info">
                                                    <i class="fas fa-clock"></i>
                                                    <span id="currentStudent">-</span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card warning">
                                                    <i class="fas fa-percentage"></i>
                                                    <span id="progressPercent">0%</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="error-log d-none" id="errorLog">
                                            <h6><i class="fas fa-exclamation-triangle"></i> تفاصيل الأخطاء:</h6>
                                            
                                            <!-- Export Button -->
                                            <div class="mb-3 text-center">
                                              <button id="exportErrorsBtn" class="upload-btn" style="background-color: #FF9500; border-color: #FF9500; color: white; margin: 0;">
                                                <i class="fas fa-download me-2"></i> تصدير الأخطاء إلى Excel
                                              </button>
                                            </div>
                                            
                                            <div class="error-summary mb-3">
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-info-circle"></i>
                                                    إجمالي الرسائل الفاشلة: <span id="totalErrors">0</span>
                                                    <br><small>يمكنك رؤية التفاصيل أدناه مع أرقام الهواتف</small>
                                                </div>
                                            </div>
                                            <div id="errorDetails"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section for "ارسال رساله عامة" -->
                    <div id="sendMsgSection" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-envelope me-2"></i> ارسال رساله عامة
                            </div>
                            <div class="card-body">
                                <div class="alert">
                                    <i class="fas fa-info-circle"></i>
                                    قم برفع ملف إكسل يحتوي على بيانات المستلمين
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <label for="recipientType">المُرسل إليه</label>
                                        <select id="recipientType" class="form-control">
                                            <option value="">اختر المُرسل إليه</option>
                                            <option value="parents">اولياء الامور فقط</option>
                                            <option value="students">الطلاب فقط</option>
                                            <option value="both">كلاهما</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <label for="parentPhoneColumnName">عمود ارقام اولياء الامور</label>
                                        <input type="text" id="parentPhoneColumnName" class="form-control" placeholder="اسم عمود ارقام اولياء الامور">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="studentPhoneColumnName">عمود ارقام الطلاب</label>
                                        <input type="text" id="studentPhoneColumnName" class="form-control" placeholder="اسم عمود ارقام الطلاب">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="nameCloumnNameGEN">عمود اسماء الطلاب</label>
                                        <input type="text" id="nameCloumnNameGEN" class="form-control" placeholder="اسم عمود اسماء الطلاب (اختياري)">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-8 mb-4">
                                        <label for="customMessage">نص الرسالة</label>
                                        <textarea id="customMessage" class="form-control" rows="4" placeholder="اكتب الرسالة التي تريد ارسالها"></textarea>
                                    </div>
                                </div>

                                <div class="upload-container">
                                    <h1>رفع ملف الإكسل</h1>
                                    <div class="file-input-wrapper">
                                        <label for="fileGEN" class="file-label" id="fileLabelGEN">
                                            <i class="fas fa-file-excel me-2"></i> اختر ملف الإكسل
                                        </label>
                                        <input type="file" id="fileGEN" name="fileGEN" accept=".xlsx, .xls" required onchange="updateFileNameGEN()">
                                    </div>
                                    <button class="upload-btn" onclick="handleFileGEN()">
                                        <i class="fas fa-paper-plane me-2"></i> إرسال الرسائل
                                    </button>

                                    <div id="progressContainerGEN" class="mt-3 d-none">
                                        <div class="progress">
                                            <div id="progressBarGEN" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-center mt-2" id="progressTextGEN">جاري الإرسال...</p>
                                    </div>

                                    <div class="output" id="outputGEN"></div>
                                    <div class="message-counter d-none" id="numberOfSendGEN">
                                        <i class="fas fa-check-circle"></i> تم إرسال <span id="msgCountGEN">0</span> رسالة
                                    </div>
                                    <div class="progress-details d-none" id="progressDetailsGEN">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="stat-card success">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span id="successCountGEN">0</span> نجح
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card error">
                                                    <i class="fas fa-times-circle"></i>
                                                    <span id="errorCountGEN">0</span> فشل
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card info">
                                                    <i class="fas fa-clock"></i>
                                                    <span id="currentStudentGEN">-</span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card warning">
                                                    <i class="fas fa-percentage"></i>
                                                    <span id="progressPercentGEN">0%</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="error-log d-none" id="errorLogGEN">
                                            <h6><i class="fas fa-exclamation-triangle"></i> تفاصيل الأخطاء:</h6>
                                            
                                            <!-- Export Button -->
                                            <div class="mb-3 text-center">
                                              <button id="exportErrorsBtnGEN" class="upload-btn" style="background-color: #FF9500; border-color: #FF9500; color: white; margin: 0;">
                                                <i class="fas fa-download me-2"></i> تصدير الأخطاء إلى Excel
                                              </button>
                                            </div>
                                            
                                            <div class="error-summary mb-3">
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-info-circle"></i>
                                                    إجمالي الرسائل الفاشلة: <span id="totalErrorsGEN">0</span>
                                                    <br><small>يمكنك رؤية التفاصيل أدناه مع أرقام الهواتف</small>
                                                </div>
                                            </div>
                                            <div id="errorDetailsGEN"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section for "ارسل الحضور" -->
                    <div id="attendanceMsgSection" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-user-check me-2"></i> ارسل الحضور
                            </div>
                            <div class="card-body">
                                <div class="alert">
                                    <i class="fas fa-info-circle"></i>
                                    قم برفع ملف إكسل يحتوي على بيانات الطلاب وحالة الحضور
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <label for="attendanceCourseName">اسم الكورس</label>
                                        <input type="text" id="attendanceCourseName" class="form-control" placeholder="مثال: Basics Course">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="attendancePhoneColumnName">عمود أرقام أولياء الأمور</label>
                                        <input type="text" id="attendancePhoneColumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="attendanceNameColumnName">عمود أسماء الطلاب</label>
                                        <input type="text" id="attendanceNameColumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="attendanceValueColumnName">عمود قيمة الحضور</label>
                                        <input type="text" id="attendanceValueColumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل (1 للحضور، 0 للغياب)">
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="attendanceTimeColumnName">عمود وقت الحضور (اختياري)</label>
                                        <input type="text" id="attendanceTimeColumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                        <small class="text-muted">اتركه فارغاً إذا لم يكن موجوداً في الملف</small>
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="cameraColumnName">عمود فتح الكاميرا (اختياري)</label>
                                        <input type="text" id="cameraColumnName" class="form-control" placeholder="اسم العمود في ملف الإكسل">
                                        <small class="text-muted">1 لفتح الكاميرا، 0 لعدم فتحها</small>
                                    </div>
                                    <div class="col-md-4 mb-4">
                                        <label for="totalSessionTime">مدة الحصة الكاملة (بالدقائق)</label>
                                        <input type="number" id="totalSessionTime" class="form-control" placeholder="مثال: 120">
                                    </div>
                                </div>

                                <div class="upload-container">
                                    <h1>رفع ملف الإكسل</h1>
                                    <div class="file-input-wrapper">
                                        <label for="fileATT" class="file-label" id="fileLabelATT">
                                            <i class="fas fa-file-excel me-2"></i> اختر ملف الإكسل
                                        </label>
                                        <input type="file" id="fileATT" name="fileATT" accept=".xlsx, .xls" required onchange="updateFileNameATT()">
                                    </div>
                                    <button class="upload-btn" onclick="handleFileATT()">
                                        <i class="fas fa-paper-plane me-2"></i> إرسال الرسائل
                                    </button>

                                    <div id="progressContainerATT" class="mt-3 d-none">
                                        <div class="progress">
                                            <div id="progressBarATT" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-center mt-2" id="progressTextATT">جاري الإرسال...</p>
                                    </div>

                                    <div class="output" id="outputATT"></div>
                                    <div class="message-counter d-none" id="numberOfSendATT">
                                        <i class="fas fa-check-circle"></i> تم إرسال <span id="msgCountATT">0</span> رسالة
                                    </div>
                                    <div class="progress-details d-none" id="progressDetailsATT">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="stat-card success">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span id="successCountATT">0</span> نجح
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card error">
                                                    <i class="fas fa-times-circle"></i>
                                                    <span id="errorCountATT">0</span> فشل
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card info">
                                                    <i class="fas fa-clock"></i>
                                                    <span id="currentStudentATT">-</span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card warning">
                                                    <i class="fas fa-percentage"></i>
                                                    <span id="progressPercentATT">0%</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="error-log d-none" id="errorLogATT">
                                            <h6><i class="fas fa-exclamation-triangle"></i> تفاصيل الأخطاء:</h6>
                                            
                                            <!-- Export Button -->
                                            <div class="mb-3 text-center">
                                              <button id="exportErrorsBtnATT" class="upload-btn" style="background-color: #FF9500; border-color: #FF9500; color: white; margin: 0;">
                                                <i class="fas fa-download me-2"></i> تصدير الأخطاء إلى Excel
                                              </button>
                                            </div>
                                            
                                            <div class="error-summary mb-3">
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-info-circle"></i>
                                                    إجمالي الرسائل الفاشلة: <span id="totalErrorsATT">0</span>
                                                    <br><small>يمكنك رؤية التفاصيل أدناه مع أرقام الهواتف</small>
                                                </div>
                                            </div>
                                            <div id="errorDetailsATT"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section for "رسالة مجمعة" -->
                    <div id="collectionMsgSection" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-layer-group me-2"></i> رسالة مجمعة (حضور/واجب/امتحان) متعددة التواريخ
                            </div>
                            <div class="card-body">
                                <div class="alert">
                                    <i class="fas fa-info-circle"></i>
                                    ارفع ملف إكسل يحتوي على الأعمدة: اسم الطالب، رقم ولي الأمر، ومجموعات متكررة بحسب البادئات التالية (تُضاف أرقام 1،2،3... تلقائيًا):
                                    Date, AttendanceValue, AttendanceTime, Camera, HWStatus, ExamEntry, QuizName, Grade, MaxGrade
                                    <br>
                                    مثال: Date, AttendanceValue, ... ثم Date2, AttendanceValue2, ... ثم Date3, AttendanceValue3, ...
                                </div>

                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <label for="collectionTitle">عنوان التقرير (اختياري)</label>
                                        <input type="text" id="collectionTitle" class="form-control" placeholder="تقرير الطالب">
                                    </div>
                                    <div class="col-md-8 mb-4">
                                        <label for="collectionHeaderIntro">مقدمة أعلى الرسالة (اختياري)</label>
                                        <input type="text" id="collectionHeaderIntro" class="form-control" placeholder="Basics Course">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3 mb-4">
                                        <label for="studentNameColumn">عمود أسماء الطلاب</label>
                                        <input type="text" id="studentNameColumn" class="form-control" placeholder="مثال: studentName" value="studentName">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="parentPhoneColumn">عمود أرقام أولياء الأمور</label>
                                        <input type="text" id="parentPhoneColumn" class="form-control" placeholder="مثال: parentPhone" value="parentPhone">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="datePrefix">بادئة التاريخ</label>
                                        <input type="text" id="datePrefix" class="form-control" placeholder="مثال: Date" value="Date">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="attendanceValuePrefix">بادئة قيمة الحضور (1/0)</label>
                                        <input type="text" id="attendanceValuePrefix" class="form-control" placeholder="مثال: AttendanceValue" value="AttendanceValue">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="attendanceTimePrefix">بادئة وقت الحضور (دقائق)</label>
                                        <input type="text" id="attendanceTimePrefix" class="form-control" placeholder="مثال: AttendanceTime" value="AttendanceTime">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="cameraPrefix">بادئة الكاميرا (1/0)</label>
                                        <input type="text" id="cameraPrefix" class="form-control" placeholder="مثال: Camera" value="Camera">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="hwStatusPrefix">بادئة حالة الواجب (1/0)</label>
                                        <input type="text" id="hwStatusPrefix" class="form-control" placeholder="مثال: HWStatus" value="HWStatus">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="examEntryPrefix">بادئة دخول الامتحان (1/0)</label>
                                        <input type="text" id="examEntryPrefix" class="form-control" placeholder="مثال: ExamEntry" value="ExamEntry">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="quizNamePrefix">بادئة اسم الامتحان</label>
                                        <input type="text" id="quizNamePrefix" class="form-control" placeholder="مثال: QuizName" value="QuizName">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="gradePrefix">بادئة الدرجة</label>
                                        <input type="text" id="gradePrefix" class="form-control" placeholder="مثال: Grade" value="Grade">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="maxGradePrefix">بادئة الدرجة النهائية</label>
                                        <input type="text" id="maxGradePrefix" class="form-control" placeholder="مثال: MaxGrade" value="MaxGrade">
                                    </div>
                                    <div class="col-md-3 mb-4">
                                        <label for="totalSessionTime">مدة الحصة (بالدقائق) لقياس الحضور الجزئي</label>
                                        <input type="number" id="totalSessionTime" class="form-control" placeholder="مثال: 120" value="120">
                                    </div>
                                </div>

                                <div class="upload-container">
                                    <h1>رفع ملف الإكسل</h1>
                                    <div class="file-input-wrapper">
                                        <label for="fileCOL" class="file-label" id="fileLabelCOL">
                                            <i class="fas fa-file-excel me-2"></i> اختر ملف الإكسل
                                        </label>
                                        <input type="file" id="fileCOL" name="fileCOL" accept=".xlsx, .xls" required onchange="updateFileNameCOL()">
                                    </div>
                                    <button class="upload-btn" onclick="handleFileCOL()">
                                        <i class="fas fa-paper-plane me-2"></i> إرسال الرسائل
                                    </button>
                                    <a href="/teacher/collectionSampleExcel" class="upload-btn" style="display:inline-block; margin-left:10px; text-decoration:none;">
                                        <i class="fas fa-download me-2"></i> تنزيل نموذج Excel
                                    </a>
                                    <button type="button" class="upload-btn" style="display:inline-block; margin-left:10px; background:#007AFF; border-color:#007AFF;" onclick="explainCollectionTemplate()">
                                        <i class="fas fa-info-circle me-2"></i> اضغط للتوضيح
                                    </button>

                                    <div id="progressContainerCOL" class="mt-3 d-none">
                                        <div class="progress">
                                            <div id="progressBarCOL" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-center mt-2" id="progressTextCOL">جاري الإرسال...</p>
                                    </div>

                                    <div class="output" id="outputCOL"></div>
                                    <div class="message-counter d-none" id="numberOfSendCOL">
                                        <i class="fas fa-check-circle"></i> تم إرسال <span id="msgCountCOL">0</span> رسالة
                                    </div>
                                    <div class="progress-details d-none" id="progressDetailsCOL">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="stat-card success">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span id="successCountCOL">0</span> نجح
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card error">
                                                    <i class="fas fa-times-circle"></i>
                                                    <span id="errorCountCOL">0</span> فشل
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card info">
                                                    <i class="fas fa-clock"></i>
                                                    <span id="currentStudentCOL">-</span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="stat-card warning">
                                                    <i class="fas fa-percentage"></i>
                                                    <span id="progressPercentCOL">0%</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="error-log d-none" id="errorLogCOL">
                                            <h6><i class="fas fa-exclamation-triangle"></i> تفاصيل الأخطاء:</h6>
                                            <div class="error-summary mb-3">
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-info-circle"></i>
                                                    إجمالي الرسائل الفاشلة: <span id="totalErrorsCOL">0</span>
                                                </div>
                                            </div>
                                            <div id="errorDetailsCOL"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script src="../assest/bootstrap.bundle.min.js"></script>
    <script src="../assest/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        const optionSelect = document.getElementById('optionSelect');
        const msgWithoutPhotoSection = document.getElementById('msgWithoutPhotoSection');
        const msgWithPhotoSection = document.getElementById('msgWithPhotoSection');
        const gradeMsgSection = document.getElementById('gradeMsgSection');
        const sendMsgSection = document.getElementById('sendMsgSection');
        const attendanceMsgSection = document.getElementById('attendanceMsgSection');
        const collectionMsgSection = document.getElementById('collectionMsgSection');

        // Event listener to show/hide sections based on selection
        optionSelect.addEventListener('change', function () {
            const selectedValue = optionSelect.value;

            // Hide all sections initially
            msgWithoutPhotoSection.classList.add('hidden');
            msgWithPhotoSection.classList.add('hidden');
            gradeMsgSection.classList.add('hidden');
            sendMsgSection.classList.add('hidden');
            attendanceMsgSection.classList.add('hidden');
            collectionMsgSection.classList.add('hidden');

            // Show corresponding section
            if (selectedValue === 'msgWithoutPhoto') {
                msgWithoutPhotoSection.classList.remove('hidden');
            } else if (selectedValue === 'msgWithPhoto') {
                msgWithPhotoSection.classList.remove('hidden');
            } else if (selectedValue === 'gradeMsg') {
                gradeMsgSection.classList.remove('hidden');
            } else if (selectedValue === 'sendMsg') {
                sendMsgSection.classList.remove('hidden');
            } else if (selectedValue === 'attendanceMsg') {
                attendanceMsgSection.classList.remove('hidden');
            } else if (selectedValue === 'collectionMsg') {
                collectionMsgSection.classList.remove('hidden');
            }
        });

        // Card toggle functions
        function toggleOnlineQuiz() {
            const onlineQuizCard = document.getElementById('onlineQuizCard');
            const onlineQuizCheckbox = document.getElementById('onlineQuizCheckbox');
            
            // Toggle checkbox
            onlineQuizCheckbox.checked = !onlineQuizCheckbox.checked;
            
            // Update card styles
            if (onlineQuizCheckbox.checked) {
                onlineQuizCard.style.borderColor = '#25D366';
                onlineQuizCard.style.boxShadow = '0 0 20px rgba(37, 211, 102, 0.3)';
                onlineQuizCheckbox.style.backgroundColor = '#25D366';
                onlineQuizCheckbox.style.borderColor = '#25D366';
                onlineQuizCard.querySelector('i').style.color = '#25D366';
            } else {
                onlineQuizCard.style.borderColor = '#666';
                onlineQuizCard.style.boxShadow = 'none';
                onlineQuizCheckbox.style.backgroundColor = '#666';
                onlineQuizCheckbox.style.borderColor = '#666';
                onlineQuizCard.querySelector('i').style.color = '#666';
            }
        }

        // Function to handle file reading
        function updateFileName() {
            const input = document.getElementById('file');
            const fileLabel = document.getElementById('fileLabel');
            if (input.files.length > 0) {
                fileLabel.innerHTML = `<i class="fas fa-file-alt"></i> ${input.files[0].name}`;
            }
        }

        // Function to handle file reading and show "Uploaded" status
        function handleFile() {
            const input = document.getElementById('file');
            const fileLabel = document.getElementById('fileLabel');

            if (!input.files.length) {
                alert('Please select a file!');
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                console.log(sheetName);
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);
                console.log(json);

                displayDataAndSend(json);

                // Update label to indicate that the file is uploaded
                fileLabel.innerHTML = `<i class="fas fa-check-circle"></i> ${file.name} (Uploaded)`;
                fileLabel.style.color = "green";
            };

            reader.readAsArrayBuffer(file);
        }

        // Function to send the data
        async function displayDataAndSend(data) {
            const output = document.getElementById('output');

            output.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> جاري إرسال الرسائل...</div>';
            const phoneCloumnName = document.getElementById('phoneCloumnName');
            const gradeCloumnName = document.getElementById('gradeCloumnName');
            const nameCloumnName = document.getElementById('nameCloumnName');
            const quizName = document.getElementById('quizName');
            const maxGrade = document.getElementById('maxGrade');
            const examEntryCloumnName = document.getElementById('examEntryCloumnName');
            const courseName = document.getElementById('courseName');
            const onlineQuizCheckbox = document.getElementById('onlineQuizCheckbox');

            if (!phoneCloumnName.value || !gradeCloumnName.value || !nameCloumnName.value || !quizName.value || !maxGrade.value ) {
                output.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> الرجاء إدخال جميع أسماء الأعمدة المطلوبة</div>';
                return;
            }

            const dataSend = {
                phoneCloumnName: phoneCloumnName.value,
                gradeCloumnName: gradeCloumnName.value,
                nameCloumnName: nameCloumnName.value,
                quizName: quizName.value,
                maxGrade: maxGrade.value,
                examEntryCloumnName: examEntryCloumnName.value || null,
                courseName: courseName.value || null,
                isOnlineQuiz: onlineQuizCheckbox.checked,
                dataToSend: data
            };

            try {
                const response = await fetch('/teacher/sendGradeMessages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataSend)
                });

                const responseData = await response.json();

                if (response.ok) {
                    output.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> تم إرسال جميع الرسائل بنجاح</div>`;
                } else if (response.status === 207) {
                    // Partial success
                    output.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            تم إرسال الرسائل مع وجود ${responseData.errorCount} أخطاء
                            <br><small>الرسائل الناجحة: ${responseData.successCount} | الرسائل الفاشلة: ${responseData.errorCount}</small>
                        </div>
                    `;
                } else {
                    output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> حدث خطأ أثناء الإرسال: ${responseData.message || 'خطأ غير معروف'}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> حدث خطأ في الاتصال: ${error.message}</div>`;
            }
        }
    
    </script>



    <script>

                // Function to handle file reading
        function updateFileNameMSG() {
            const input = document.getElementById('fileMSG');
            const fileLabel = document.getElementById('fileLabelMSG');
            if (input.files.length > 0) {
                fileLabel.innerHTML = `<i class="fas fa-file-alt"></i> ${input.files[0].name}`;
            }
        }

        // Function to handle file reading and show "Uploaded" status
        function handleFileMSG() {
            const input = document.getElementById('fileMSG');
            const fileLabel = document.getElementById('fileLabelMSG');

            if (!input.files.length) {
                alert('Please select a file!');
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                console.log(sheetName);
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);
                console.log(json);

                displayDataAndSendMSG(json);

                // Update label to indicate that the file is uploaded
                fileLabel.innerHTML = `<i class="fas fa-check-circle"></i> ${file.name} (Uploaded)`;
                fileLabel.style.color = "green";
            };

            reader.readAsArrayBuffer(file);
        }

        // Function to send the data
        async function displayDataAndSendMSG(data) {
            const output = document.getElementById('outputMSG');

            output.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> جاري إرسال الرسائل...</div>';
            const phoneCloumnName = document.getElementById('phoneCloumnNameMSG');
            const nameCloumnNameMSG = document.getElementById('nameCloumnNameMSG');
            const HWCloumnName = document.getElementById('HWCloumnName');
            const courseNameMSG = document.getElementById('courseNameMSG');

            if (!phoneCloumnName.value  || !nameCloumnNameMSG.value || !HWCloumnName.value ) {
                output.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> الرجاء إدخال جميع أسماء الأعمدة المطلوبة</div>';
                return;
            }

            const dataSend = {
                phoneCloumnName: phoneCloumnName.value,
                nameCloumnName: nameCloumnNameMSG.value,
                HWCloumnName: HWCloumnName.value,
                courseName: courseNameMSG.value || 'Basics Course',
                dataToSend: data
            };

            try {
                const response = await fetch('/teacher/sendMessages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataSend)
                });

                const responseData = await response.json();

                if (response.ok) {
                    output.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> تم إرسال جميع الرسائل بنجاح</div>`;
                } else if (response.status === 207) {
                    // Partial success
                    output.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            تم إرسال الرسائل مع وجود ${responseData.errorCount} أخطاء
                            <br><small>الرسائل الناجحة: ${responseData.successCount} | الرسائل الفاشلة: ${responseData.errorCount}</small>
                        </div>
                    `;
                } else {
                    output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> حدث خطأ أثناء الإرسال: ${responseData.message || 'خطأ غير معروف'}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> حدث خطأ في الاتصال: ${error.message}</div>`;
            }
        }
    

        
    </script>

    <script>
        // General message upload and send
        function updateFileNameGEN() {
            const input = document.getElementById('fileGEN');
            const fileLabel = document.getElementById('fileLabelGEN');
            if (input.files.length > 0) {
                fileLabel.innerHTML = `<i class="fas fa-file-alt"></i> ${input.files[0].name}`;
            }
        }

        function handleFileGEN() {
            const input = document.getElementById('fileGEN');
            const fileLabel = document.getElementById('fileLabelGEN');

            if (!input.files.length) {
                alert('Please select a file!');
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);

                displayDataAndSendGEN(json);

                fileLabel.innerHTML = `<i class=\"fas fa-check-circle\"></i> ${file.name} (Uploaded)`;
                fileLabel.style.color = "green";
            };

            reader.readAsArrayBuffer(file);
        }

        async function displayDataAndSendGEN(data) {
            const output = document.getElementById('outputGEN');
            output.innerHTML = 'data is being sent...';

            const recipientType = document.getElementById('recipientType').value;
            const parentPhoneColumnName = document.getElementById('parentPhoneColumnName').value;
            const studentPhoneColumnName = document.getElementById('studentPhoneColumnName').value;
            const nameCloumnNameGEN = document.getElementById('nameCloumnNameGEN').value;
            const customMessage = document.getElementById('customMessage').value;

            if (!recipientType || !customMessage) {
                alert('الرجاء اختيار المُرسل إليه وكتابة الرسالة');
                return;
            }

            if ((recipientType === 'parents' || recipientType === 'both') && !parentPhoneColumnName) {
                alert('ادخل اسم عمود ارقام اولياء الامور');
                return;
            }
            if ((recipientType === 'students' || recipientType === 'both') && !studentPhoneColumnName) {
                alert('ادخل اسم عمود ارقام الطلاب');
                return;
            }

            const payload = {
                recipientType,
                parentPhoneColumnName,
                studentPhoneColumnName,
                nameCloumnName: nameCloumnNameGEN,
                message: customMessage,
                dataToSend: data
            };

            try {
                const response = await fetch('/teacher/sendCustomMessages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json();
                if (response.ok) {
                    output.innerHTML = `<h2>تم الارسال بنجاح</h2>`;
                    output.style.color = 'green';
                } else {
                    output.innerHTML = `<h2>حدث خطأ أثناء الارسال</h2>`;
                    output.style.color = 'red';
                }
            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = `<h2>حدث خطأ أثناء الارسال</h2>`;
                output.style.color = 'red';
            }
        }
    </script>

    <script>
        // Attendance message upload and send
        function updateFileNameATT() {
            const input = document.getElementById('fileATT');
            const fileLabel = document.getElementById('fileLabelATT');
            if (input.files.length > 0) {
                fileLabel.innerHTML = `<i class="fas fa-file-alt"></i> ${input.files[0].name}`;
            }
        }

        function handleFileATT() {
            const input = document.getElementById('fileATT');
            const fileLabel = document.getElementById('fileLabelATT');

            if (!input.files.length) {
                alert('Please select a file!');
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);

                displayDataAndSendATT(json);

                fileLabel.innerHTML = `<i class="fas fa-check-circle"></i> ${file.name} (Uploaded)`;
                fileLabel.style.color = "green";
            };

            reader.readAsArrayBuffer(file);
        }

        async function displayDataAndSendATT(data) {
            const output = document.getElementById('outputATT');
            output.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> جاري إرسال الرسائل...</div>';

            const attendanceCourseName = document.getElementById('attendanceCourseName').value;
            const attendancePhoneColumnName = document.getElementById('attendancePhoneColumnName').value;
            const attendanceNameColumnName = document.getElementById('attendanceNameColumnName').value;
            const attendanceValueColumnName = document.getElementById('attendanceValueColumnName').value;
            const attendanceTimeColumnName = document.getElementById('attendanceTimeColumnName').value;
            const cameraColumnName = document.getElementById('cameraColumnName').value;
            const totalSessionTime = document.getElementById('totalSessionTime').value;

            if (!attendanceCourseName || !attendancePhoneColumnName || !attendanceNameColumnName || !attendanceValueColumnName || !totalSessionTime) {
                output.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> الرجاء إدخال جميع الحقول المطلوبة</div>';
                return;
            }

            const dataSend = {
                courseName: attendanceCourseName,
                phoneColumnName: attendancePhoneColumnName,
                nameColumnName: attendanceNameColumnName,
                attendanceValueColumnName: attendanceValueColumnName,
                attendanceTimeColumnName: attendanceTimeColumnName || null,
                cameraColumnName: cameraColumnName || null,
                totalSessionTime: parseInt(totalSessionTime),
                dataToSend: data
            };

            try {
                const response = await fetch('/teacher/sendAttendanceMessages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataSend)
                });

                const responseData = await response.json();

                if (response.ok) {
                    output.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> تم إرسال جميع الرسائل بنجاح</div>`;
                } else if (response.status === 207) {
                    // Partial success
                    output.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            تم إرسال الرسائل مع وجود ${responseData.errorCount} أخطاء
                            <br><small>الرسائل الناجحة: ${responseData.successCount} | الرسائل الفاشلة: ${responseData.errorCount}</small>
                        </div>
                    `;
                } else {
                    output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> حدث خطأ أثناء الإرسال: ${responseData.message || 'خطأ غير معروف'}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> حدث خطأ في الاتصال: ${error.message}</div>`;
            }
        }
    </script>

    <script>
        // Collection message upload and send
        function updateFileNameCOL() {
            const input = document.getElementById('fileCOL');
            const fileLabel = document.getElementById('fileLabelCOL');
            if (input.files.length > 0) {
                fileLabel.innerHTML = `<i class="fas fa-file-alt"></i> ${input.files[0].name}`;
            }
        }

        function handleFileCOL() {
            const input = document.getElementById('fileCOL');
            const fileLabel = document.getElementById('fileLabelCOL');

            if (!input.files.length) {
                alert('Please select a file!');
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);

                displayDataAndSendCOL(json);

                fileLabel.innerHTML = `<i class="fas fa-check-circle"></i> ${file.name} (Uploaded)`;
                fileLabel.style.color = "green";
            };

            reader.readAsArrayBuffer(file);
        }

        async function displayDataAndSendCOL(data) {
            const output = document.getElementById('outputCOL');
            output.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> جاري إرسال الرسائل...</div>';

            const studentNameColumn = document.getElementById('studentNameColumn').value;
            const parentPhoneColumn = document.getElementById('parentPhoneColumn').value;
            const datePrefix = document.getElementById('datePrefix').value;
            const attendanceValuePrefix = document.getElementById('attendanceValuePrefix').value;
            const attendanceTimePrefix = document.getElementById('attendanceTimePrefix').value;
            const cameraPrefix = document.getElementById('cameraPrefix').value;
            const hwStatusPrefix = document.getElementById('hwStatusPrefix').value;
            const examEntryPrefix = document.getElementById('examEntryPrefix').value;
            const quizNamePrefix = document.getElementById('quizNamePrefix').value;
            const gradePrefix = document.getElementById('gradePrefix').value;
            const maxGradePrefix = document.getElementById('maxGradePrefix').value;
            const totalSessionTime = document.getElementById('totalSessionTime').value;
            const headerIntro = document.getElementById('collectionHeaderIntro').value;
            const title = document.getElementById('collectionTitle').value;

            if (!studentNameColumn || !parentPhoneColumn || !datePrefix) {
                output.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> الرجاء إدخال أعمدة الاسم ورقم ولي الأمر وبادئة التاريخ</div>';
                return;
            }

            const payload = {
                studentNameColumn,
                parentPhoneColumn,
                datePrefix,
                datePrefixStructured: datePrefix,
                attendanceValuePrefix,
                attendanceTimePrefix,
                cameraPrefix,
                hwStatusPrefix,
                examEntryPrefix,
                quizNamePrefix,
                gradePrefix,
                maxGradePrefix,
                totalSessionTime: Number(totalSessionTime) || undefined,
                headerIntro,
                title,
                dataToSend: data
            };

            try {
                const response = await fetch('/teacher/sendCollectionMessages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json();
                if (response.ok) {
                    output.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> تم إرسال جميع الرسائل بنجاح</div>`;
                } else if (response.status === 207) {
                    output.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            تم إرسال الرسائل مع وجود ${responseData.errorCount} أخطاء
                            <br><small>الرسائل الناجحة: ${responseData.successCount} | الرسائل الفاشلة: ${responseData.errorCount}</small>
                        </div>
                    `;
                } else {
                    output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> حدث خطأ أثناء الإرسال: ${responseData.message || 'خطأ غير معروف'}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> حدث خطأ في الاتصال: ${error.message}</div>`;
            }
        }
        
        function explainCollectionTemplate() {
            const msg = `صيغة النموذج:\n\n` +
`أعمدة ثابتة: studentName, parentPhone\n` +
`مجموعة متكررة لكل تاريخ (يمكن تكرارها بإضافة 2,3,...):\n` +
`- Date, AttendanceValue (1/0), AttendanceTime (بالدقائق), Camera (1/0),\n` +
`- HWStatus (1/0), ExamEntry (1/0), QuizName, Grade, MaxGrade\n\n` +
`مثال للأعمدة: Date, AttendanceValue, AttendanceTime, Camera, HWStatus, ExamEntry, QuizName, Grade, MaxGrade, Date2, AttendanceValue2, ...`;
            alert(msg);
        }
    </script>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const numberOfSend = document.getElementById('numberOfSend');
        const numberOfSendMSG = document.getElementById('numberOfSendMSG');
        const numberOfSendGEN = document.getElementById('numberOfSendGEN');
        const numberOfSendATT = document.getElementById('numberOfSendATT');
        
        // Progress details for grade messages
        const progressDetails = document.getElementById('progressDetails');
        const successCount = document.getElementById('successCount');
        const errorCount = document.getElementById('errorCount');
        const currentStudent = document.getElementById('currentStudent');
        const progressPercent = document.getElementById('progressPercent');
        const errorLog = document.getElementById('errorLog');
        const errorDetails = document.getElementById('errorDetails');
        const totalErrors = document.getElementById('totalErrors');
        
        // Progress details for homework messages
        const progressDetailsMSG = document.getElementById('progressDetailsMSG');
        const successCountMSG = document.getElementById('successCountMSG');
        const errorCountMSG = document.getElementById('errorCountMSG');
        const currentStudentMSG = document.getElementById('currentStudentMSG');
        const progressPercentMSG = document.getElementById('progressPercentMSG');
        const errorLogMSG = document.getElementById('errorLogMSG');
        const errorDetailsMSG = document.getElementById('errorDetailsMSG');
        const totalErrorsMSG = document.getElementById('totalErrorsMSG');
        
        // Progress details for general messages
        const progressDetailsGEN = document.getElementById('progressDetailsGEN');
        const successCountGEN = document.getElementById('successCountGEN');
        const errorCountGEN = document.getElementById('errorCountGEN');
        const currentStudentGEN = document.getElementById('currentStudentGEN');
        const progressPercentGEN = document.getElementById('progressPercentGEN');
        const errorLogGEN = document.getElementById('errorLogGEN');
        const errorDetailsGEN = document.getElementById('errorDetailsGEN');
        const totalErrorsGEN = document.getElementById('totalErrorsGEN');
        
        // Progress details for attendance messages
        const progressDetailsATT = document.getElementById('progressDetailsATT');
        const successCountATT = document.getElementById('successCountATT');
        const errorCountATT = document.getElementById('errorCountATT');
        const currentStudentATT = document.getElementById('currentStudentATT');
        const progressPercentATT = document.getElementById('progressPercentATT');
        const errorLogATT = document.getElementById('errorLogATT');
        const errorDetailsATT = document.getElementById('errorDetailsATT');
        const totalErrorsATT = document.getElementById('totalErrorsATT');
        
        // Progress details for collection messages
        const numberOfSendCOL = document.getElementById('numberOfSendCOL');
        const progressDetailsCOL = document.getElementById('progressDetailsCOL');
        const successCountCOL = document.getElementById('successCountCOL');
        const errorCountCOL = document.getElementById('errorCountCOL');
        const currentStudentCOL = document.getElementById('currentStudentCOL');
        const progressPercentCOL = document.getElementById('progressPercentCOL');
        const errorLogCOL = document.getElementById('errorLogCOL');
        const errorDetailsCOL = document.getElementById('errorDetailsCOL');
        const totalErrorsCOL = document.getElementById('totalErrorsCOL');
        
        const socket = io();

        socket.on('sendingMessages', (data) => {
            // Determine which section this update belongs to based on the current active section
            let activeSection = 'grade'; // default
            
            // Check which section is currently visible
            if (!gradeMsgSection.classList.contains('hidden')) {
                activeSection = 'grade';
            } else if (!msgWithoutPhotoSection.classList.contains('hidden')) {
                activeSection = 'homework';
            } else if (!sendMsgSection.classList.contains('hidden')) {
                activeSection = 'general';
            } else if (!attendanceMsgSection.classList.contains('hidden')) {
                activeSection = 'attendance';
            } else if (!collectionMsgSection.classList.contains('hidden')) {
                activeSection = 'collection';
            }
            
            // Update the appropriate progress details section
            if (activeSection === 'grade') {
                updateProgressSection(progressDetails, successCount, errorCount, currentStudent, progressPercent, errorLog, errorDetails, numberOfSend, data, totalErrors);
            } else if (activeSection === 'homework') {
                updateProgressSection(progressDetailsMSG, successCountMSG, errorCountMSG, currentStudentMSG, progressPercentMSG, errorLogMSG, errorDetailsMSG, numberOfSendMSG, data, totalErrorsMSG);
            } else if (activeSection === 'general') {
                updateProgressSection(progressDetailsGEN, successCountGEN, errorCountGEN, currentStudentGEN, progressPercentGEN, errorLogGEN, errorDetailsGEN, numberOfSendGEN, data, totalErrorsGEN);
            } else if (activeSection === 'attendance') {
                updateProgressSection(progressDetailsATT, successCountATT, errorCountATT, currentStudentATT, progressPercentATT, errorLogATT, errorDetailsATT, numberOfSendATT, data, totalErrorsATT);
            } else if (activeSection === 'collection') {
                updateProgressSection(progressDetailsCOL, successCountCOL, errorCountCOL, currentStudentCOL, progressPercentCOL, errorLogCOL, errorDetailsCOL, numberOfSendCOL, data, totalErrorsCOL);
            }
        });
        
        function updateProgressSection(progressDetails, successCount, errorCount, currentStudent, progressPercent, errorLog, errorDetails, numberOfSend, data, totalErrorsElement) {
            // Show progress details
            progressDetails.classList.remove('d-none');
            
            // Update counters
            if (data.totalMessages) {
                numberOfSend.classList.remove('d-none');
                
                const percent = Math.round((data.nMessages / data.totalMessages) * 100);
                progressPercent.textContent = `${percent}%`;
                
                if (data.nMessages) {
                    numberOfSend.innerHTML = `تم إرسال ${data.nMessages} من ${data.totalMessages} رسالة`;
                }
            }
            
            // Update statistics
            if (data.successCount !== undefined) successCount.textContent = data.successCount;
            if (data.errorCount !== undefined) errorCount.textContent = data.errorCount;
            if (data.currentStudent) currentStudent.textContent = data.currentStudent;
            
            // Handle status changes
            if (data.status === 'starting') {
                console.log('🚀 Starting message sending...');
            } else if (data.status === 'progress') {
                if (data.lastResult === 'error') {
                    console.log(`❌ Error sending to ${data.currentStudent}: ${data.lastError}`);
                } else {
                    console.log(`✅ Success sending to ${data.currentStudent}`);
                }
            } else if (data.status === 'completed') {
                console.log(`✅ Completed: ${data.successCount} success, ${data.errorCount} errors`);
                
                // Show error details if any
                if (data.errors && data.errors.length > 0) {
                    errorLog.classList.remove('d-none');
                    errorDetails.innerHTML = '';
                    
                    // Update total errors count
                    if (totalErrorsElement) {
                        totalErrorsElement.textContent = data.errors.length;
                    }
                    
                    data.errors.forEach(error => {
                        const errorItem = document.createElement('div');
                        errorItem.className = 'error-item';
                        errorItem.innerHTML = `
                            <div class="error-header">
                                <span class="student-name"><i class="fas fa-user"></i> ${error.student}</span>
                                <span class="phone-number" onclick="copyPhoneNumber('${error.phone || ''}')" title="انقر للنسخ"><i class="fas fa-phone"></i> ${error.phone || 'غير متوفر'}</span>
                            </div>
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i> ${error.error}
                            </div>
                            <div class="error-timestamp">
                                <small><i class="fas fa-clock"></i> ${new Date(error.timestamp).toLocaleString('ar-EG')}</small>
                            </div>
                        `;
                        errorDetails.appendChild(errorItem);
                    });
                }
            } else if (data.status === 'failed') {
                console.error(`💥 Critical error: ${data.error}`);
                alert(`حدث خطأ حرج: ${data.error}`);
            }
        }

        // Function to copy phone number to clipboard
        function copyPhoneNumber(phoneNumber) {
            if (phoneNumber && phoneNumber !== 'غير متوفر') {
                navigator.clipboard.writeText(phoneNumber).then(() => {
                    // Show temporary success message
                    const tempMessage = document.createElement('div');
                    tempMessage.className = 'copy-success-message';
                    tempMessage.innerHTML = '<i class="fas fa-check"></i> تم نسخ رقم الهاتف';
                    tempMessage.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background-color: #25D366;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 8px;
                        z-index: 9999;
                        font-weight: 600;
                        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
                    `;
                    document.body.appendChild(tempMessage);
                    
                    setTimeout(() => {
                        tempMessage.remove();
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy phone number:', err);
                    alert('فشل في نسخ رقم الهاتف');
                });
            }
        }
    </script>

    <script>
        // Export function for Grade Messages (errorLog)
        async function exportErrorsToExcel() {
            const exportBtn = document.getElementById('exportErrorsBtn');
            const originalText = exportBtn.innerHTML;
            
            try {
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> جاري التصدير...';
                
                const errorElements = document.querySelectorAll('#errorDetails .error-item');
                const errors = [];
                
                errorElements.forEach((errorElement) => {
                    const studentName = errorElement.querySelector('.student-name')?.textContent?.replace(/^[^a-zA-Z\u0600-\u06FF\s]+/, '').trim() || '';
                    const phoneNumber = errorElement.querySelector('.phone-number')?.textContent?.replace(/^[^0-9\s]+/, '').trim() || '';
                    const errorMessage = errorElement.querySelector('.error-message')?.textContent?.replace(/^[^a-zA-Z\u0600-\u06FF\s]+/, '').trim() || '';
                    
                    errors.push({
                        student: studentName,
                        phone: phoneNumber,
                        hwStatus: 'Failed',
                        error: errorMessage
                    });
                });
                
                if (errors.length === 0) {
                    alert('لا توجد أخطاء للتصدير');
                    return;
                }
                
                const response = await fetch('/teacher/exportErrorDetailsToExcel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ errors })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ErrorDetails_Grade_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showSuccessMessage('تم تصدير الأخطاء بنجاح');
                } else {
                    const errorData = await response.json();
                    alert(`فشل في تصدير الأخطاء: ${errorData.message || 'خطأ غير معروف'}`);
                }
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('حدث خطأ أثناء التصدير: ' + error.message);
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalText;
            }
        }

        // Export function for Homework Messages (errorLogMSG)
        async function exportErrorsToExcelMSG() {
            const exportBtn = document.getElementById('exportErrorsBtnMSG');
            const originalText = exportBtn.innerHTML;
            
            try {
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> جاري التصدير...';
                
                const errorElements = document.querySelectorAll('#errorDetailsMSG .error-item');
                const errors = [];
                
                errorElements.forEach((errorElement) => {
                    const studentName = errorElement.querySelector('.student-name')?.textContent?.replace(/^[^a-zA-Z\u0600-\u06FF\s]+/, '').trim() || '';
                    const phoneNumber = errorElement.querySelector('.phone-number')?.textContent?.replace(/^[^0-9\s]+/, '').trim() || '';
                    const errorMessage = errorElement.querySelector('.error-message')?.textContent?.replace(/^[^a-zA-Z\u0600-\u06FF\s]+/, '').trim() || '';
                    
                    errors.push({
                        student: studentName,
                        phone: phoneNumber,
                        hwStatus: 'Failed',
                        error: errorMessage
                    });
                });
                
                if (errors.length === 0) {
                    alert('لا توجد أخطاء للتصدير');
                    return;
                }
                
                const response = await fetch('/teacher/exportErrorDetailsToExcel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ errors })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ErrorDetails_Homework_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showSuccessMessage('تم تصدير الأخطاء بنجاح');
                } else {
                    const errorData = await response.json();
                    alert(`فشل في تصدير الأخطاء: ${errorData.message || 'خطأ غير معروف'}`);
                }
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('حدث خطأ أثناء التصدير: ' + error.message);
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalText;
            }
        }

        // Export function for General Messages (errorLogGEN)
        async function exportErrorsToExcelGEN() {
            const exportBtn = document.getElementById('exportErrorsBtnGEN');
            const originalText = exportBtn.innerHTML;
            
            try {
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> جاري التصدير...';
                
                const errorElements = document.querySelectorAll('#errorDetailsGEN .error-item');
                const errors = [];
                
                errorElements.forEach((errorElement) => {
                    const studentName = errorElement.querySelector('.student-name')?.textContent?.replace(/^[^a-zA-Z\u0600-\u06FF\s]+/, '').trim() || '';
                    const phoneNumber = errorElement.querySelector('.phone-number')?.textContent?.replace(/^[^0-9\s]+/, '').trim() || '';
                    const errorMessage = errorElement.querySelector('.error-message')?.textContent?.replace(/^[^a-zA-Z\u0600-\u06FF\s]+/, '').trim() || '';
                    
                    errors.push({
                        student: studentName,
                        phone: phoneNumber,
                        hwStatus: 'Failed',
                        error: errorMessage
                    });
                });
                
                if (errors.length === 0) {
                    alert('لا توجد أخطاء للتصدير');
                    return;
                }
                
                const response = await fetch('/teacher/exportErrorDetailsToExcel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ errors })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ErrorDetails_General_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showSuccessMessage('تم تصدير الأخطاء بنجاح');
                } else {
                    const errorData = await response.json();
                    alert(`فشل في تصدير الأخطاء: ${errorData.message || 'خطأ غير معروف'}`);
                }
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('حدث خطأ أثناء التصدير: ' + error.message);
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalText;
            }
        }

        // Helper function to show success messages
        function showSuccessMessage(message) {
            const successMessage = document.createElement('div');
            successMessage.className = 'copy-success-message';
            successMessage.innerHTML = `<i class="fas fa-check"></i> ${message}`;
            successMessage.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #25D366;
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                z-index: 9999;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
            `;
            document.body.appendChild(successMessage);
            
            setTimeout(() => {
                successMessage.remove();
            }, 3000);
        }

        // Export function for Attendance Messages (errorLogATT)
        async function exportErrorsToExcelATT() {
            const exportBtn = document.getElementById('exportErrorsBtnATT');
            const originalText = exportBtn.innerHTML;
            
            try {
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> جاري التصدير...';
                
                const errorElements = document.querySelectorAll('#errorDetailsATT .error-item');
                const errors = [];
                
                errorElements.forEach((errorElement) => {
                    const studentName = errorElement.querySelector('.student-name')?.textContent?.replace(/^[^a-zA-Z\u0600-\u06FF\s]+/, '').trim() || '';
                    const phoneNumber = errorElement.querySelector('.phone-number')?.textContent?.replace(/^[^0-9\s]+/, '').trim() || '';
                    const errorMessage = errorElement.querySelector('.error-message')?.textContent?.replace(/^[^a-zA-Z\u0600-\u06FF\s]+/, '').trim() || '';
                    
                    errors.push({
                        student: studentName,
                        phone: phoneNumber,
                        attendanceStatus: 'Failed',
                        error: errorMessage
                    });
                });
                
                if (errors.length === 0) {
                    alert('لا توجد أخطاء للتصدير');
                    return;
                }
                
                const response = await fetch('/teacher/exportErrorDetailsToExcel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ errors })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ErrorDetails_Attendance_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showSuccessMessage('تم تصدير الأخطاء بنجاح');
                } else {
                    const errorData = await response.json();
                    alert(`فشل في تصدير الأخطاء: ${errorData.message || 'خطأ غير معروف'}`);
                }
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('حدث خطأ أثناء التصدير: ' + error.message);
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalText;
            }
        }

        // Add event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Attach export functions to buttons
            const exportBtn = document.getElementById('exportErrorsBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportErrorsToExcel);
            }
            
            const exportBtnMSG = document.getElementById('exportErrorsBtnMSG');
            if (exportBtnMSG) {
                exportBtnMSG.addEventListener('click', exportErrorsToExcelMSG);
            }
            
            const exportBtnGEN = document.getElementById('exportErrorsBtnGEN');
            if (exportBtnGEN) {
                exportBtnGEN.addEventListener('click', exportErrorsToExcelGEN);
            }
            
            const exportBtnATT = document.getElementById('exportErrorsBtnATT');
            if (exportBtnATT) {
                exportBtnATT.addEventListener('click', exportErrorsToExcelATT);
            }
        });
    </script>
</body>

</html>
